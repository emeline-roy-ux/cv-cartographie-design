<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CV cartographique — Design & Recherche</title>

<style>
body { font-family: system-ui, sans-serif; margin: 40px; background:#f5f5f5; color:#222; }
.grid { display:grid; grid-template-columns:1.6fr 1fr; gap:18px; }
.card { background:#fff; padding:18px; border-radius:10px; box-shadow:0 0 0 1px #ddd; }
#viz { width:100%; height:560px; background:#fff; border-radius:10px; box-shadow:0 0 0 1px #ddd; }
.meta { font-size:13px; color:#666; }
.tag { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; margin:4px; font-size:12px; }
button { border:1px solid #ddd; background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; }

@media (max-width:900px){
 body { margin:18px; }
 .grid { grid-template-columns:1fr; }
 #viz { height:520px; }
}
</style>
</head>

<body>

<div class="card" style="margin-bottom:18px;">
<strong>CV cartographique — dispositif de recherche-création</strong>
<p class="meta">
Prototype contrôlé : profil · publications · recherche · enseignements  
PDF académique complet : disponible sur demande
</p>
</div>

<div class="grid">
<div id="viz"></div>

<div class="card">
<strong>Fiche</strong>
<button id="resetBtn">Réinitialiser</button>
<p class="meta" id="hint">Survol = résumé · clic = déployer</p>
<div id="panel"></div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
(async function(){

const data = await fetch("data.json").then(r=>r.json());

const W = viz.clientWidth;
const H = viz.clientHeight;

const svg = d3.select("#viz").append("svg")
.attr("width",W).attr("height",H);

const g = svg.append("g");

svg.call(d3.zoom().scaleExtent([0.6,2.5]).on("zoom",e=>g.attr("transform",e.transform)));


// ---------- fonds de zones

const zones = [
{label:"PROFIL", x:0, y:0},
{label:"PUBLICATIONS", x:.5, y:0},
{label:"RECHERCHE", x:0, y:.5},
{label:"ENSEIGNEMENTS", x:.5, y:.5}
];

svg.selectAll(".zbg")
.data(zones)
.join("rect")
.attr("x",d=>d.x*W)
.attr("y",d=>d.y*H)
.attr("width",W/2)
.attr("height",H/2)
.attr("fill","#fafafa");

svg.selectAll(".zlabel")
.data(zones)
.join("text")
.attr("x",d=>d.x*W+20)
.attr("y",d=>d.y*H+26)
.text(d=>d.label)
.attr("font-size",12)
.attr("fill","#999");


// ---------- voisins

const neighbors = {};
data.links.forEach(l=>{
 neighbors[l.source] ??= new Set();
 neighbors[l.target] ??= new Set();
 neighbors[l.source].add(l.target);
 neighbors[l.target].add(l.source);
});

const macroTypes = new Set(["profil","axe","institution","reseau","position","hub"]);
let visible = new Set(data.nodes.filter(n=>macroTypes.has(n.type)).map(n=>n.id));


// ---------- graph

const link = g.selectAll("line")
.data(data.links)
.join("line")
.attr("stroke","#ddd");

const node = g.selectAll("circle")
.data(data.nodes)
.join("circle")
.attr("r",d=> d.type==="hub"?18:(d.type==="axe"?14:10))
.attr("fill",d=> d.type==="hub"?"#f0f0f0":"#fff")
.attr("stroke","#555");

const label = g.selectAll("text.node")
.data(data.nodes)
.join("text")
.attr("class","node")
.text(d=>d.label)
.attr("font-size",12)
.attr("dx",14)
.attr("dy",4);


// ---------- forces zones

const zx={profil:.25,publications:.75,recherche:.25,enseignement:.75};
const zy={profil:.25,publications:.25,recherche:.75,enseignement:.75};

const sim = d3.forceSimulation(data.nodes)
.force("link",d3.forceLink(data.links).id(d=>d.id).distance(55).strength(.08))
.force("charge",d3.forceManyBody().strength(-160))
.force("x",d3.forceX(d=>W*(zx[d.zone]??.5)).strength(.8))
.force("y",d3.forceY(d=>H*(zy[d.zone]??.5)).strength(.8))
.force("collide",d3.forceCollide(22));

sim.on("tick",()=>{
 link.attr("x1",d=>d.source.x).attr("y1",d=>d.source.y)
     .attr("x2",d=>d.target.x).attr("y2",d=>d.target.y);
 node.attr("cx",d=>d.x).attr("cy",d=>d.y);
 label.attr("x",d=>d.x).attr("y",d=>d.y);
});


// ---------- visibilité

function update(){
 node.attr("display",d=>visible.has(d.id)?null:"none");
 label.attr("display",d=>visible.has(d.id)?null:"none");
 link.attr("display",d=>{
   const s=d.source.id||d.source;
   const t=d.target.id||d.target;
   return (visible.has(s)&&visible.has(t))?null:"none";
 });
}


// ---------- panel

function show(d){
 panel.innerHTML =
 `<strong>${d.label}</strong><br>
 ${(d.keywords||[]).map(k=>`<span class="tag">${k}</span>`).join("")}
 ${d.evidence?`<p><a href="${d.evidence}" target="_blank">preuve</a></p>`:""}`;
}

node.on("mouseover",(e,d)=>show(d))
.on("click",(e,d)=>{
 visible.add(d.id);
 (neighbors[d.id]||[]).forEach(id=>visible.add(id));
 update();
 if(d.evidence) window.open(d.evidence,"_blank");
});

resetBtn.onclick=()=>{
 visible=new Set(data.nodes.filter(n=>macroTypes.has(n.type)).map(n=>n.id));
 update();
 panel.innerHTML="";
};

node.call(d3.drag()
.on("start",(e,d)=>{ if(!e.active) sim.alphaTarget(.3).restart(); d.fx=d.x; d.fy=d.y; })
.on("drag",(e,d)=>{ d.fx=e.x; d.fy=e.y; })
.on("end",(e,d)=>{ if(!e.active) sim.alphaTarget(0); d.fx=null; d.fy=null; })
);

update();

})();
</script>
</body>
</html>
